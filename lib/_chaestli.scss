////
/// Grid library for all your basic grid needs!
////

/// Dependencies and components
///
@import '../vendor/@dreipol/scss-mq/index';
@import '../vendor/@dreipol/scss-utils/mixins/at-root';
@import './chaestli__vars';
@import './chaestli__helpers';
@import './chaestli__basics';


/// Fix buggy support for percentage values of `flex-basis` in IE10 and IE11.
/// @link https://github.com/philipwalton/flexbugs#7-flex-basis-doesnt-account-for-box-sizingborder-box
///
@mixin grid--fix-ie-flex-basis() {
    @include dp-at-root(html, '.ie11') {
        flex-basis: auto;
        @content;
    }

    @include dp-at-root(html, '.ie10') {
        flex-basis: auto;
        @content;
    }
}

/// Add basic grid styling to elements with a certain naming convention adapted from bootstrap
/// @param {string} $cfg.root - A root module name (BEM) including a dot
/// @param {string} $cfg.mq - A media expression that is parseable by `include-media`
/// @param {string} $cfg.container - BEM element describing a container
/// @param {string} $cfg.row - BEM element describing a row
/// @param {List} $cfg.cols - One or multiple BEM element describing a col
/// @param {string|number} $cfg.container-size - The grid-container's size
///
@mixin grid--root($cfg: ()) {
    // Merge default values with config
    $defaults: (
        root: grid--bem-root,
        mq: null,
        container: 'container',
        row: 'row',
        cols: ('col'),
    );
    $cfg: map-merge($defaults, $cfg);

    // Write config values into variables for code readability
    $cfg-root: map-get($cfg, 'root');
    $cfg-mq: map-get($cfg, 'mq');
    $cfg-container: map-get($cfg, 'container');
    $cfg-row: map-get($cfg, 'row');
    $cfg-cols: map-get($cfg, 'cols');

    // Calculate additionally needed values
    $col-names: grid--col-name-list($cfg-root, $cfg-cols...);

    @include mq($cfg-mq) {
        #{$cfg-root}#{$bem-element-separator}#{$cfg-container} {
            @include grid--define-container;
        }

        #{$cfg-root}#{$bem-element-separator}#{$cfg-row} {
            @include grid--define-row;
        }

        #{$col-names} {
            @include grid--define-col;
        }
    }
}

/// Define the maximum size of a grid by adding a `max-width` to the container
/// @param {string} $cfg.root - A root module name (BEM) including a dot
/// @param {string} $cfg.mq - A media expression that is parseable by `include-media`
/// @param {string} $cfg.container - BEM element describing a container
/// @param {string|number} $cfg.container-size - The grid-container's size
///
@mixin grid--constrain($cfg: ()) {
    // Merge default values with config
    $defaults: (
        root: grid--bem-root,
        mq: null,
        container: 'container',
        container-size: none,
        size-prop: 'max-width',
    );
    $cfg: map-merge($defaults, $cfg);

    // Write config values into variables for code readability
    $cfg-root: map-get($cfg, 'root');
    $cfg-mq: map-get($cfg, 'mq');
    $cfg-container: map-get($cfg, 'container');
    $cfg-container-size: map-get($cfg, 'container-size');
    $cfg-size-prop: map-get($cfg, 'size-prop');

    @include mq($cfg-mq) {
        #{$cfg-root}#{$bem-element-separator}#{$cfg-container} {
            #{$cfg-size-prop}: $cfg-container-size;
        }
    }
}

/// Scaffold spacing in between cols and between cols and container
/// @param {string} $cfg.root - A root module name (BEM) including a dot
/// @param {string} $cfg.mq - A media expression that is parseable by `include-media`
/// @param {string} $cfg.container - BEM element describing a container
/// @param {string} $cfg.row - BEM element describing a row
/// @param {List} $cfg.cols - One or multiple BEM element describing a col
/// @param {number} $cfg.gutter - The desired inner gutter size in any spacial unit
/// @param {number} $cfg.edge - The desired edge clearance in any spacial unit
///
@mixin grid--space($cfg: ()) {
    // Merge default values with config
    $defaults: (
        root: grid--bem-root,
        mq: null,
        container: 'container',
        row: 'row',
        cols: ('col'),
        gutter: 0,
        edge: null,
    );
    $cfg: map-merge($defaults, $cfg);

    // Write config values into variables for code readability
    $cfg-root: map-get($cfg, 'root');
    $cfg-mq: map-get($cfg, 'mq');
    $cfg-container: map-get($cfg, 'container');
    $cfg-row: map-get($cfg, 'row');
    $cfg-cols: map-get($cfg, 'cols');
    $cfg-gutter: map-get($cfg, 'gutter');
    $cfg-edge: map-get($cfg, 'edge');

    // Calculate additionally needed values
    $col-names: grid--col-name-list($cfg-root, $cfg-cols...);
    $gutters: grid--configurate-gutter($cfg-gutter);
    $edges: grid--configurate-gutter(if($cfg-edge, $cfg-edge, $cfg-gutter));

    @include mq($cfg-mq) {
        #{$cfg-root}#{$bem-element-separator}#{$cfg-container} {
            @include grid--write-gutter('padding', $edges);

            #{$cfg-root}#{$bem-element-separator}#{$cfg-container}:not(.u-iknowwhatimdoing) {
                // NOTE: Nested containers are not allowed, please nest rows/cols instead!
                visibility: hidden !important; // stylelint-disable-line declaration-no-important

                &::before {
                    visibility: visible;
                    content: 'Nested `grid--container` detected!';
                    font-size: 20px;
                    line-height: 1.2;
                    color: red; // stylelint-disable-line color-named
                }
            }
        }

        #{$cfg-root}#{$bem-element-separator}#{$cfg-row} {
            @include grid--write-gutter('margin', $gutters, -0.5);
        }

        #{$col-names} {
            @include grid--write-gutter('padding', $gutters, 0.5);
        }
    }
}

/// Define the col's size in flex notation
/// @param {unitless} $cfg.ratio - A unitless ratio value (0 < x <= 1)
/// @param {string} $cfg.mq - A media expression that is parseable by `include-media`
/// @param {string} $cfg.fallback - A property name that serves as fallback in IE10 and IE11
///
@mixin grid--span($cfg: ()) {
    // Merge default values with config
    $defaults: (
        ratio: null,
        mq: null,
        fallback-prop: 'width',
    );
    $cfg: map-merge($defaults, $cfg);

    // Write config values into variables for code readability
    $cfg-ratio: map-get($cfg, 'ratio');
    $cfg-mq: map-get($cfg, 'mq');
    $cfg-fallback-prop: map-get($cfg, 'fallback-prop');

    // Calculate additionally needed values
    $percentage: (100% * $cfg-ratio);

    @include mq($cfg-mq) {
        flex: 0 0 $percentage;

        @include grid--fix-ie-flex-basis {
            #{$cfg-fallback-prop}: $percentage;
        }
    }
}

/// Standalone version of `grid--span` with the same config
///
@mixin grid--col($cfg: ()) {
    @include grid--define-col;
    @include grid--span($cfg);
}
